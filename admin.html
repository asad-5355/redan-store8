<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم مطعم ريدان دبي</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #e63946;
            --secondary: #f1faee;
            --accent: #a8dadc;
            --dark: #1d3557;
            --light: #f8f9fa;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
        }
        
        .admin-container {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 250px;
            background-color: var(--dark);
            color: white;
            padding: 1.5rem 0;
            transition: all 0.3s;
        }
        
        .sidebar-header {
            padding: 0 1.5rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-header h2 {
            font-size: 1.2rem;
            display: flex;
            align-items: center;
        }
        
        .sidebar-header h2 i {
            margin-left: 10px;
        }
        
        .sidebar-menu {
            margin-top: 1.5rem;
        }
        
        .menu-item {
            padding: 12px 1.5rem;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
        }
        
        .menu-item:hover, .menu-item.active {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .menu-item i {
            margin-left: 10px;
            width: 20px;
            text-align: center;
        }
        
        .main-content {
            flex: 1;
            overflow-x: hidden;
        }
        
        .topbar {
            background-color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .search-bar {
            display: flex;
            align-items: center;
            background-color: #f5f7fa;
            border-radius: 5px;
            padding: 8px 15px;
            width: 300px;
        }
        
        .search-bar input {
            border: none;
            background: none;
            outline: none;
            width: 100%;
            margin-right: 10px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
        }
        
        .user-info img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-left: 15px;
        }
        
        .content {
            padding: 1.5rem;
        }
        
        .page-title {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: var(--dark);
            display: flex;
            align-items: center;
        }
        
        .page-title i {
            margin-left: 10px;
        }
        
        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .card {
            background-color: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .card-title {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
        }
        
        .card-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--dark);
        }
        
        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 15px;
            font-size: 1.5rem;
        }
        
        .card.orders .card-icon {
            background-color: rgba(230, 57, 70, 0.1);
            color: var(--primary);
        }
        
        .card.products .card-icon {
            background-color: rgba(29, 53, 87, 0.1);
            color: var(--dark);
        }
        
        .card.revenue .card-icon {
            background-color: rgba(168, 218, 220, 0.1);
            color: var(--accent);
        }
        
        .card.customers .card-icon {
            background-color: rgba(241, 250, 238, 0.1);
            color: #4caf50;
        }
        
        .table-container {
            background-color: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background-color: #f9f9f9;
            font-weight: 600;
            color: var(--dark);
        }
        
        tr:hover {
            background-color: #f5f7fa;
        }
        
        .status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status.new {
            background-color: rgba(230, 57, 70, 0.1);
            color: var(--primary);
        }
        
        .status.preparing {
            background-color: rgba(255, 165, 0, 0.1);
            color: orange;
        }
        
        .status.delivering {
            background-color: rgba(29, 53, 87, 0.1);
            color: var(--dark);
        }
        
        .status.completed {
            background-color: rgba(76, 175, 80, 0.1);
            color: #4caf50;
        }
        
        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
            margin-right: 10px;
            transition: color 0.3s;
        }
        
        .action-btn:hover {
            color: var(--primary);
        }
        
        .form-container {
            background-color: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            max-width: 800px;
            margin: 0 auto;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        textarea.form-control {
            min-height: 100px;
        }
        
        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: #c1121f;
        }
        
        .btn-secondary {
            background-color: #666;
        }
        
        .btn-secondary:hover {
            background-color: #555;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            padding: 1.5rem;
            position: relative;
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            left: 15px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        .modal-title {
            margin-bottom: 1.5rem;
            text-align: center;
            color: var(--dark);
        }
        
        .tab-container {
            margin-bottom: 1.5rem;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
            font-weight: 500;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
                overflow: hidden;
            }
            
            .sidebar-header h2 span {
                display: none;
            }
            
            .menu-item span {
                display: none;
            }
            
            .menu-item i {
                margin-left: 0;
                font-size: 1.2rem;
            }
            
            .search-bar {
                width: auto;
            }
            
            .search-bar input {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-utensils"></i> <span>ريدان دبي</span></h2>
            </div>
            <div class="sidebar-menu">
                <div class="menu-item active" data-tab="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>لوحة التحكم</span>
                </div>
                <div class="menu-item" data-tab="orders">
                    <i class="fas fa-shopping-bag"></i>
                    <span>الطلبات</span>
                </div>
                <div class="menu-item" data-tab="products">
                    <i class="fas fa-hamburger"></i>
                    <span>المنتجات</span>
                </div>
                <div class="menu-item" data-tab="categories">
                    <i class="fas fa-tags"></i>
                    <span>الفئات</span>
                </div>
                <div class="menu-item" data-tab="customers">
                    <i class="fas fa-users"></i>
                    <span>العملاء</span>
                </div>
                <div class="menu-item" data-tab="settings">
                    <i class="fas fa-cog"></i>
                    <span>الإعدادات</span>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="topbar">
                <div class="search-bar">
                    <input type="text" placeholder="بحث...">
                    <i class="fas fa-search"></i>
                </div>
                <div class="user-info">
                    <span>مدير النظام</span>
                    <img src="https://via.placeholder.com/40" alt="صورة المستخدم">
                </div>
            </div>
            
            <div class="content">
                <!-- لوحة التحكم -->
                <div class="tab-content active" id="dashboard">
                    <h2 class="page-title"><i class="fas fa-tachometer-alt"></i> لوحة التحكم</h2>
                    
                    <div class="cards">
                        <div class="card orders">
                            <p class="card-title">الطلبات الجديدة</p>
                            <p class="card-value" id="newOrdersCount">0</p>
                            <div class="card-icon">
                                <i class="fas fa-shopping-bag"></i>
                            </div>
                        </div>
                        <div class="card products">
                            <p class="card-title">المنتجات</p>
                            <p class="card-value" id="productsCount">0</p>
                            <div class="card-icon">
                                <i class="fas fa-hamburger"></i>
                            </div>
                        </div>
                        <div class="card revenue">
                            <p class="card-title">الإيرادات اليوم</p>
                            <p class="card-value" id="todayRevenue">0</p>
                            <div class="card-icon">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                        </div>
                        <div class="card customers">
                            <p class="card-title">عملاء جدد</p>
                            <p class="card-value" id="newCustomersCount">0</p>
                            <div class="card-icon">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                    </div>
                    
                    <h3 class="page-title"><i class="fas fa-shopping-bag"></i> أحدث الطلبات</h3>
                    <div class="table-container">
                        <table id="recentOrdersTable">
                            <thead>
                                <tr>
                                    <th>رقم الطلب</th>
                                    <th>العميل</th>
                                    <th>التاريخ</th>
                                    <th>المجموع</th>
                                    <th>الحالة</th>
                                    <th>إجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- سيتم ملؤها بالبيانات -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- الطلبات -->
                <div class="tab-content" id="orders">
                    <h2 class="page-title"><i class="fas fa-shopping-bag"></i> إدارة الطلبات</h2>
                    
                    <div class="table-container">
                        <div class="tabs">
                            <div class="tab active" data-status="all">الكل</div>
                            <div class="tab" data-status="new">جديد</div>
                            <div class="tab" data-status="preparing">قيد التحضير</div>
                            <div class="tab" data-status="delivering">قيد التوصيل</div>
                            <div class="tab" data-status="completed">مكتمل</div>
                        </div>
                        
                        <table id="ordersTable">
                            <thead>
                                <tr>
                                    <th>رقم الطلب</th>
                                    <th>العميل</th>
                                    <th>الهاتف</th>
                                    <th>العنوان</th>
                                    <th>المجموع</th>
                                    <th>الحالة</th>
                                    <th>إجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- سيتم ملؤها بالبيانات -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- المنتجات -->
                <div class="tab-content" id="products">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 class="page-title"><i class="fas fa-hamburger"></i> إدارة المنتجات</h2>
                        <button class="btn" id="addProductBtn"><i class="fas fa-plus"></i> إضافة منتج</button>
                    </div>
                    
                    <div class="table-container">
                        <table id="productsTable">
                            <thead>
                                <tr>
                                    <th>الصورة</th>
                                    <th>الاسم</th>
                                    <th>الفئة</th>
                                    <th>السعر</th>
                                    <th>متوفر</th>
                                    <th>إجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- سيتم ملؤها بالبيانات -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- الفئات -->
                <div class="tab-content" id="categories">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 class="page-title"><i class="fas fa-tags"></i> إدارة الفئات</h2>
                        <button class="btn" id="addCategoryBtn"><i class="fas fa-plus"></i> إضافة فئة</button>
                    </div>
                    
                    <div class="table-container">
                        <table id="categoriesTable">
                            <thead>
                                <tr>
                                    <th>الاسم</th>
                                    <th>عدد المنتجات</th>
                                    <th>إجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- سيتم ملؤها بالبيانات -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- العملاء -->
                <div class="tab-content" id="customers">
                    <h2 class="page-title"><i class="fas fa-users"></i> إدارة العملاء</h2>
                    
                    <div class="table-container">
                        <table id="customersTable">
                            <thead>
                                <tr>
                                    <th>الاسم</th>
                                    <th>الهاتف</th>
                                    <th>عدد الطلبات</th>
                                    <th>آخر طلب</th>
                                    <th>إجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- سيتم ملؤها بالبيانات -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- الإعدادات -->
                <div class="tab-content" id="settings">
                    <h2 class="page-title"><i class="fas fa-cog"></i> الإعدادات</h2>
                    
                    <div class="form-container">
                        <form id="settingsForm">
                            <div class="form-group">
                                <label for="restaurantName">اسم المطعم</label>
                                <input type="text" id="restaurantName" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="deliveryFee">رسوم التوصيل (درهم)</label>
                                <input type="number" id="deliveryFee" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="deliveryTime">وقت التوصيل المتوقع (دقيقة)</label>
                                <input type="number" id="deliveryTime" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="workingHours">ساعات العمل</label>
                                <input type="text" id="workingHours" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="contactPhone">رقم الهاتف</label>
                                <input type="text" id="contactPhone" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="contactEmail">البريد الإلكتروني</label>
                                <input type="email" id="contactEmail" class="form-control">
                            </div>
                            <button type="submit" class="btn">حفظ التغييرات</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal إضافة/تعديل منتج -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <button class="close-modal" id="closeProductModal"><i class="fas fa-times"></i></button>
            <h3 class="modal-title" id="productModalTitle">إضافة منتج جديد</h3>
            <form id="productForm">
                <input type="hidden" id="productId">
                <div class="form-group">
                    <label for="productName">اسم المنتج</label>
                    <input type="text" id="productName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="productCategory">الفئة</label>
                    <select id="productCategory" class="form-control" required>
                        <!-- سيتم ملؤها بالخيارات -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="productPrice">السعر (درهم)</label>
                    <input type="number" id="productPrice" class="form-control" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="productDescription">الوصف</label>
                    <textarea id="productDescription" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="productImage">صورة المنتج (URL)</label>
                    <input type="text" id="productImage" class="form-control">
                </div>
                <div class="form-group">
                    <label for="productAvailable">متوفر</label>
                    <select id="productAvailable" class="form-control">
                        <option value="true">نعم</option>
                        <option value="false">لا</option>
                    </select>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <button type="button" class="btn btn-secondary" id="cancelProduct">إلغاء</button>
                    <button type="submit" class="btn">حفظ</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal إضافة/تعديل فئة -->
    <div class="modal" id="categoryModal">
        <div class="modal-content">
            <button class="close-modal" id="closeCategoryModal"><i class="fas fa-times"></i></button>
            <h3 class="modal-title" id="categoryModalTitle">إضافة فئة جديدة</h3>
            <form id="categoryForm">
                <input type="hidden" id="categoryId">
                <div class="form-group">
                    <label for="categoryName">اسم الفئة</label>
                    <input type="text" id="categoryName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="categoryImage">صورة الفئة (URL)</label>
                    <input type="text" id="categoryImage" class="form-control">
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <button type="button" class="btn btn-secondary" id="cancelCategory">إلغاء</button>
                    <button type="submit" class="btn">حفظ</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal تفاصيل الطلب -->
    <div class="modal" id="orderModal">
        <div class="modal-content" style="max-width: 700px;">
            <button class="close-modal" id="closeOrderModal"><i class="fas fa-times"></i></button>
            <h3 class="modal-title">تفاصيل الطلب #<span id="orderNumber"></span></h3>
            
            <div style="display: flex; margin-bottom: 1.5rem;">
                <div style="flex: 1; padding: 0 10px;">
                    <h4 style="margin-bottom: 10px;">معلومات العميل</h4>
                    <p><strong>الاسم:</strong> <span id="customerName"></span></p>
                    <p><strong>الهاتف:</strong> <span id="customerPhone"></span></p>
                    <p><strong>العنوان:</strong> <span id="customerAddress"></span></p>
                    <p><strong>ملاحظات:</strong> <span id="orderNotes"></span></p>
                </div>
                <div style="flex: 1; padding: 0 10px;">
                    <h4 style="margin-bottom: 10px;">معلومات الطلب</h4>
                    <p><strong>التاريخ:</strong> <span id="orderDate"></span></p>
                    <p><strong>الحالة:</strong> 
                        <select id="orderStatus" class="form-control" style="display: inline-block; width: auto;">
                            <option value="new">جديد</option>
                            <option value="preparing">قيد التحضير</option>
                            <option value="delivering">قيد التوصيل</option>
                            <option value="completed">مكتمل</option>
                        </select>
                    </p>
                    <p><strong>المجموع:</strong> <span id="orderTotal"></span> درهم</p>
                </div>
            </div>
            
            <h4 style="margin-bottom: 10px;">المنتجات</h4>
            <div class="table-container" style="margin-bottom: 1.5rem;">
                <table>
                    <thead>
                        <tr>
                            <th>الصورة</th>
                            <th>الاسم</th>
                            <th>الكمية</th>
                            <th>السعر</th>
                            <th>المجموع</th>
                        </tr>
                    </thead>
                    <tbody id="orderItems">
                        <!-- سيتم ملؤها بالبيانات -->
                    </tbody>
                </table>
            </div>
            
            <div style="display: flex; justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" id="cancelOrder" style="margin-left: 10px;">إغلاق</button>
                <button type="button" class="btn" id="updateOrderStatus">تحديث الحالة</button>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // تهيئة Supabase
        const supabaseUrl = 'https://mhragdzdcdaqtipvrogl.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ocmFnZHpkY2RhcXRpcHZyb2dsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAwMzQwNTMsImV4cCI6MjA2NTYxMDA1M30.Qt2Lj7lcGJ2hwHaF9TJOwlN1Gwf00DjtdkJL9JoK-dA';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);
        
        // عناصر DOM
        const menuItems = document.querySelectorAll('.menu-item');
        const tabContents = document.querySelectorAll('.tab-content');
        const tabs = document.querySelectorAll('.tab');
        const addProductBtn = document.getElementById('addProductBtn');
        const productModal = document.getElementById('productModal');
        const closeProductModal = document.getElementById('closeProductModal');
        const cancelProduct = document.getElementById('cancelProduct');
        const productForm = document.getElementById('productForm');
        const addCategoryBtn = document.getElementById('addCategoryBtn');
        const categoryModal = document.getElementById('categoryModal');
        const closeCategoryModal = document.getElementById('closeCategoryModal');
        const cancelCategory = document.getElementById('cancelCategory');
        const categoryForm = document.getElementById('categoryForm');
        const orderModal = document.getElementById('orderModal');
        const closeOrderModal = document.getElementById('closeOrderModal');
        const cancelOrder = document.getElementById('cancelOrder');
        const updateOrderStatus = document.getElementById('updateOrderStatus');
        const orderStatus = document.getElementById('orderStatus');
        
        // تغيير التبويبات
        menuItems.forEach(item => {
            item.addEventListener('click', () => {
                const tabId = item.dataset.tab;
                
                menuItems.forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                
                tabContents.forEach(content => content.classList.remove('active'));
                document.getElementById(tabId).classList.add('active');
            });
        });
        
        // تغيير حالة الطلبات
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                if (!tab.classList.contains('tab')) return;
                
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                const status = tab.dataset.status;
                loadOrders(status);
            });
        });
        
        // فتح/إغلاق Modal المنتج
        addProductBtn.addEventListener('click', () => {
            document.getElementById('productModalTitle').textContent = 'إضافة منتج جديد';
            document.getElementById('productId').value = '';
            productForm.reset();
            loadCategoriesForSelect();
            productModal.classList.add('active');
        });
        
        closeProductModal.addEventListener('click', () => {
            productModal.classList.remove('active');
        });
        
        cancelProduct.addEventListener('click', () => {
            productModal.classList.remove('active');
        });
        
        // فتح/إغلاق Modal الفئة
        addCategoryBtn.addEventListener('click', () => {
            document.getElementById('categoryModalTitle').textContent = 'إضافة فئة جديدة';
            document.getElementById('categoryId').value = '';
            categoryForm.reset();
            categoryModal.classList.add('active');
        });
        
        closeCategoryModal.addEventListener('click', () => {
            categoryModal.classList.remove('active');
        });
        
        cancelCategory.addEventListener('click', () => {
            categoryModal.classList.remove('active');
        });
        
        // فتح/إغلاق Modal الطلب
        closeOrderModal.addEventListener('click', () => {
            orderModal.classList.remove('active');
        });
        
        cancelOrder.addEventListener('click', () => {
            orderModal.classList.remove('active');
        });
        
        // تحديث حالة الطلب
        updateOrderStatus.addEventListener('click', async () => {
            const orderId = orderModal.dataset.orderId;
            const status = orderStatus.value;
            
            try {
                const { data, error } = await supabase
                    .from('orders')
                    .update({ status: status })
                    .eq('id', orderId)
                    .select();
                
                if (error) throw error;
                
                alert('تم تحديث حالة الطلب بنجاح');
                orderModal.classList.remove('active');
                loadOrders(document.querySelector('.tab.active').dataset.status);
                loadDashboardData();
            } catch (error) {
                console.error('Error updating order status:', error);
                alert('حدث خطأ أثناء تحديث حالة الطلب');
            }
        });
        
        // تحميل الفئات لـ select
        async function loadCategoriesForSelect() {
            try {
                const { data, error } = await supabase
                    .from('categories')
                    .select('*');
                
                if (error) throw error;
                
                const select = document.getElementById('productCategory');
                select.innerHTML = '';
                
                data.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }
        
        // تحميل بيانات لوحة التحكم
        async function loadDashboardData() {
            try {
                // عدد الطلبات الجديدة
                const { count: newOrdersCount } = await supabase
                    .from('orders')
                    .select('*', { count: 'exact', head: true })
                    .eq('status', 'new');
                
                document.getElementById('newOrdersCount').textContent = newOrdersCount || 0;
                
                // عدد المنتجات
                const { count: productsCount } = await supabase
                    .from('products')
                    .select('*', { count: 'exact', head: true });
                
                document.getElementById('productsCount').textContent = productsCount || 0;
                
                // الإيرادات اليوم
                const today = new Date().toISOString().split('T')[0];
                const { data: todayRevenueData } = await supabase
                    .from('orders')
                    .select('total')
                    .gte('created_at', `${today}T00:00:00`)
                    .lte('created_at', `${today}T23:59:59`);
                
                const todayRevenue = todayRevenueData?.reduce((sum, order) => sum + order.total, 0) || 0;
                document.getElementById('todayRevenue').textContent = todayRevenue.toFixed(2);
                
                // عدد العملاء الجدد
                const { count: newCustomersCount } = await supabase
                    .from('customers')
                    .select('*', { count: 'exact', head: true })
                    .gte('created_at', `${today}T00:00:00`)
                    .lte('created_at', `${today}T23:59:59`);
                
                document.getElementById('newCustomersCount').textContent = newCustomersCount || 0;
                
                // أحدث الطلبات
                const { data: recentOrders } = await supabase
                    .from('orders')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(5);
                
                const tbody = document.querySelector('#recentOrdersTable tbody');
                tbody.innerHTML = '';
                
                if (recentOrders && recentOrders.length > 0) {
                    recentOrders.forEach(order => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>#${order.id}</td>
                            <td>${order.customer_name}</td>
                            <td>${new Date(order.created_at).toLocaleDateString()}</td>
                            <td>${order.total.toFixed(2)} درهم</td>
                            <td><span class="status ${order.status}">${getStatusText(order.status)}</span></td>
                            <td>
                                <button class="action-btn view-order" data-id="${order.id}"><i class="fas fa-eye"></i></button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                    
                    // إضافة أحداث لعرض تفاصيل الطلب
                    document.querySelectorAll('.view-order').forEach(btn => {
                        btn.addEventListener('click', () => viewOrderDetails(btn.dataset.id));
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">لا توجد طلبات</td></tr>';
                }
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }
        
        // تحميل الطلبات
        async function loadOrders(status = 'all') {
            try {
                let query = supabase
                    .from('orders')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (status !== 'all') {
                    query = query.eq('status', status);
                }
                
                const { data: orders, error } = await query;
                
                if (error) throw error;
                
                const tbody = document.querySelector('#ordersTable tbody');
                tbody.innerHTML = '';
                
                if (orders && orders.length > 0) {
                    orders.forEach(order => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>#${order.id}</td>
                            <td>${order.customer_name}</td>
                            <td>${order.customer_phone}</td>
                            <td>${order.customer_address.substring(0, 20)}...</td>
                            <td>${order.total.toFixed(2)} درهم</td>
                            <td><span class="status ${order.status}">${getStatusText(order.status)}</span></td>
                            <td>
                                <button class="action-btn view-order" data-id="${order.id}"><i class="fas fa-eye"></i></button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                    
                    // إضافة أحداث لعرض تفاصيل الطلب
                    document.querySelectorAll('.view-order').forEach(btn => {
                        btn.addEventListener('click', () => viewOrderDetails(btn.dataset.id));
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">لا توجد طلبات</td></tr>';
                }
                
            } catch (error) {
                console.error('Error loading orders:', error);
            }
        }
        
        // عرض تفاصيل الطلب
        async function viewOrderDetails(orderId) {
            try {
                const { data: order, error } = await supabase
                    .from('orders')
                    .select('*')
                    .eq('id', orderId)
                    .single();
                
                if (error) throw error;
                
                // تعبئة البيانات
                document.getElementById('orderNumber').textContent = order.id;
                document.getElementById('customerName').textContent = order.customer_name;
                document.getElementById('customerPhone').textContent = order.customer_phone;
                document.getElementById('customerAddress').textContent = order.customer_address;
                document.getElementById('orderNotes').textContent = order.notes || 'لا يوجد';
                document.getElementById('orderDate').textContent = new Date(order.created_at).toLocaleString();
                document.getElementById('orderTotal').textContent = order.total.toFixed(2);
                orderStatus.value = order.status;
                
                // تعبئة العناصر
                const tbody = document.getElementById('orderItems');
                tbody.innerHTML = '';
                
                order.items.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><img src="${item.image_url}" alt="${item.name}" style="width: 50px; height: 50px; object-fit: cover;"></td>
                        <td>${item.name}</td>
                        <td>${item.quantity}</td>
                        <td>${item.price.toFixed(2)} درهم</td>
                        <td>${(item.price * item.quantity).toFixed(2)} درهم</td>
                    `;
                    tbody.appendChild(tr);
                });
                
                orderModal.dataset.orderId = order.id;
                orderModal.classList.add('active');
                
            } catch (error) {
                console.error('Error loading order details:', error);
                alert('حدث خطأ أثناء تحميل تفاصيل الطلب');
            }
        }
        
        // تحميل المنتجات
        async function loadProducts() {
            try {
                const { data: products, error } = await supabase
                    .from('products')
                    .select('*');
                
                if (error) throw error;
                
                const tbody = document.querySelector('#productsTable tbody');
                tbody.innerHTML = '';
                
                if (products && products.length > 0) {
                    products.forEach(product => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td><img src="${product.image_url}" alt="${product.name}" style="width: 50px; height: 50px; object-fit: cover;"></td>
                            <td>${product.name}</td>
                            <td>${product.category}</td>
                            <td>${product.price.toFixed(2)} درهم</td>
                            <td>${product.available ? 'نعم' : 'لا'}</td>
                            <td>
                                <button class="action-btn edit-product" data-id="${product.id}"><i class="fas fa-edit"></i></button>
                                <button class="action-btn delete-product" data-id="${product.id}"><i class="fas fa-trash"></i></button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                    
                    // إضافة أحداث التعديل والحذف
                    document.querySelectorAll('.edit-product').forEach(btn => {
                        btn.addEventListener('click', () => editProduct(btn.dataset.id));
                    });
                    
                    document.querySelectorAll('.delete-product').forEach(btn => {
                        btn.addEventListener('click', () => deleteProduct(btn.dataset.id));
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">لا توجد منتجات</td></tr>';
                }
                
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }
        
        // تحميل الفئات
        async function loadCategories() {
            try {
                const { data: categories, error } = await supabase
                    .from('categories')
                    .select('*');
                
                if (error) throw error;
                
                const tbody = document.querySelector('#categoriesTable tbody');
                tbody.innerHTML = '';
                
                if (categories && categories.length > 0) {
                    categories.forEach(category => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${category.name}</td>
                            <td>0</td>
                            <td>
                                <button class="action-btn edit-category" data-id="${category.id}"><i class="fas fa-edit"></i></button>
                                <button class="action-btn delete-category" data-id="${category.id}"><i class="fas fa-trash"></i></button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                    
                    // إضافة أحداث التعديل والحذف
                    document.querySelectorAll('.edit-category').forEach(btn => {
                        btn.addEventListener('click', () => editCategory(btn.dataset.id));
                    });
                    
                    document.querySelectorAll('.delete-category').forEach(btn => {
                        btn.addEventListener('click', () => deleteCategory(btn.dataset.id));
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center;">لا توجد فئات</td></tr>';
                }
                
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }
        
        // تحميل العملاء
        async function loadCustomers() {
            try {
                const { data: customers, error } = await supabase
                    .from('customers')
                    .select('*');
                
                if (error) throw error;
                
                const tbody = document.querySelector('#customersTable tbody');
                tbody.innerHTML = '';
                
                if (customers && customers.length > 0) {
                    customers.forEach(customer => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${customer.name}</td>
                            <td>${customer.phone}</td>
                            <td>0</td>
                            <td>-</td>
                            <td>
                                <button class="action-btn"><i class="fas fa-eye"></i></button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">لا توجد عملاء</td></tr>';
                }
                
            } catch (error) {
                console.error('Error loading customers:', error);
            }
        }
        
        // تحميل الإعدادات
        async function loadSettings() {
            try {
                const { data: settings, error } = await supabase
                    .from('settings')
                    .select('*')
                    .single();
                
                if (error && error.code !== 'PGRST116') throw error;
                
                if (settings) {
                    document.getElementById('restaurantName').value = settings.restaurant_name || '';
                    document.getElementById('deliveryFee').value = settings.delivery_fee || '';
                    document.getElementById('deliveryTime').value = settings.delivery_time || '';
                    document.getElementById('workingHours').value = settings.working_hours || '';
                    document.getElementById('contactPhone').value = settings.contact_phone || '';
                    document.getElementById('contactEmail').value = settings.contact_email || '';
                }
                
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }
        
        // تعديل منتج
        async function editProduct(productId) {
            try {
                const { data: product, error } = await supabase
                    .from('products')
                    .select('*')
                    .eq('id', productId)
                    .single();
                
                if (error) throw error;
                
                document.getElementById('productModalTitle').textContent = 'تعديل المنتج';
                document.getElementById('productId').value = product.id;
                document.getElementById('productName').value = product.name;
                document.getElementById('productPrice').value = product.price;
                document.getElementById('productDescription').value = product.description;
                document.getElementById('productImage').value = product.image_url;
                document.getElementById('productAvailable').value = product.available;
                
                await loadCategoriesForSelect();
                document.getElementById('productCategory').value = product.category;
                
                productModal.classList.add('active');
                
            } catch (error) {
                console.error('Error editing product:', error);
                alert('حدث خطأ أثناء تحميل بيانات المنتج');
            }
        }
        
        // حذف منتج
        async function deleteProduct(productId) {
            if (!confirm('هل أنت متأكد من حذف هذا المنتج؟')) return;
            
            try {
                const { error } = await supabase
                    .from('products')
                    .delete()
                    .eq('id', productId);
                
                if (error) throw error;
                
                alert('تم حذف المنتج بنجاح');
                loadProducts();
                
            } catch (error) {
                console.error('Error deleting product:', error);
                alert('حدث خطأ أثناء حذف المنتج');
            }
        }
        
        // تعديل فئة
        async function editCategory(categoryId) {
            try {
                const { data: category, error } = await supabase
                    .from('categories')
                    .select('*')
                    .eq('id', categoryId)
                    .single();
                
                if (error) throw error;
                
                document.getElementById('categoryModalTitle').textContent = 'تعديل الفئة';
                document.getElementById('categoryId').value = category.id;
                document.getElementById('categoryName').value = category.name;
                document.getElementById('categoryImage').value = category.image_url || '';
                
                categoryModal.classList.add('active');
                
            } catch (error) {
                console.error('Error editing category:', error);
                alert('حدث خطأ أثناء تحميل بيانات الفئة');
            }
        }
        
        // حذف فئة
        async function deleteCategory(categoryId) {
            if (!confirm('هل أنت متأكد من حذف هذه الفئة؟')) return;
            
            try {
                const { error } = await supabase
                    .from('categories')
                    .delete()
                    .eq('id', categoryId);
                
                if (error) throw error;
                
                alert('تم حذف الفئة بنجاح');
                loadCategories();
                
            } catch (error) {
                console.error('Error deleting category:', error);
                alert('حدث خطأ أثناء حذف الفئة');
            }
        }
        
        // حفظ المنتج
        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const productId = document.getElementById('productId').value;
            const productData = {
                name: document.getElementById('productName').value,
                category: document.getElementById('productCategory').value,
                price: parseFloat(document.getElementById('productPrice').value),
                description: document.getElementById('productDescription').value,
                image_url: document.getElementById('productImage').value,
                available: document.getElementById('productAvailable').value === 'true'
            };
            
            try {
                if (productId) {
                    // تحديث المنتج
                    const { error } = await supabase
                        .from('products')
                        .update(productData)
                        .eq('id', productId);
                    
                    if (error) throw error;
                    
                    alert('تم تحديث المنتج بنجاح');
                } else {
                    // إضافة منتج جديد
                    const { error } = await supabase
                        .from('products')
                        .insert([productData]);
                    
                    if (error) throw error;
                    
                    alert('تم إضافة المنتج بنجاح');
                }
                
                productModal.classList.remove('active');
                loadProducts();
                
            } catch (error) {
                console.error('Error saving product:', error);
                alert('حدث خطأ أثناء حفظ المنتج');
            }
        });
        
        // حفظ الفئة
        categoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const categoryId = document.getElementById('categoryId').value;
            const categoryData = {
                name: document.getElementById('categoryName').value,
                image_url: document.getElementById('categoryImage').value || null
            };
            
            try {
                if (categoryId) {
                    // تحديث الفئة
                    const { error } = await supabase
                        .from('categories')
                        .update(categoryData)
                        .eq('id', categoryId);
                    
                    if (error) throw error;
                    
                    alert('تم تحديث الفئة بنجاح');
                } else {
                    // إضافة فئة جديدة
                    const { error } = await supabase
                        .from('categories')
                        .insert([categoryData]);
                    
                    if (error) throw error;
                    
                    alert('تم إضافة الفئة بنجاح');
                }
                
                categoryModal.classList.remove('active');
                loadCategories();
                
            } catch (error) {
                console.error('Error saving category:', error);
                alert('حدث خطأ أثناء حفظ الفئة');
            }
        });
        
        // حفظ الإعدادات
        document.getElementById('settingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const settingsData = {
                restaurant_name: document.getElementById('restaurantName').value,
                delivery_fee: parseFloat(document.getElementById('deliveryFee').value) || 0,
                delivery_time: parseInt(document.getElementById('deliveryTime').value) || 45,
                working_hours: document.getElementById('workingHours').value,
                contact_phone: document.getElementById('contactPhone').value,
                contact_email: document.getElementById('contactEmail').value
            };
            
            try {
                const { error } = await supabase
                    .from('settings')
                    .upsert([settingsData]);
                
                if (error) throw error;
                
                alert('تم حفظ الإعدادات بنجاح');
                
            } catch (error) {
                console.error('Error saving settings:', error);
                alert('حدث خطأ أثناء حفظ الإعدادات');
            }
        });
        
        // الحصول على نص الحالة
        function getStatusText(status) {
            const statusTexts = {
                'new': 'جديد',
                'preparing': 'قيد التحضير',
                'delivering': 'قيد التوصيل',
                'completed': 'مكتمل'
            };
            
            return statusTexts[status] || status;
        }
        
        // تحميل البيانات عند بدء التحميل
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboardData();
            loadOrders();
            loadProducts();
            loadCategories();
            loadCustomers();
            loadSettings();
        });
    </script>
</body>
</html>
